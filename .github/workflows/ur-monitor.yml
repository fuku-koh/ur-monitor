name: UR monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"  # 10分ごと（Python側でJST 09:30-19:00以外はスキップ）

jobs:
  run:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        prop: [ "5390", "7080" ]  # 監視したい物件IDを並べる
    env:
      PROP_ID: ${{ matrix.prop }}
      CHATWORK_TOKEN: ${{ secrets.CHATWORK_TOKEN }}
      CHATWORK_ROOM_ID: ${{ secrets.CHATWORK_ROOM_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run monitor (${{ matrix.prop }})
        run: python ur_monitor.py

      - name: Persist state (${{ matrix.prop }})
        if: always()
        run: |
          git config user.name  "ur-monitor-bot"
          git config user.email "bot@example.com"
          git add .state_${{ matrix.prop }}.json || true
          git add .hb_${{ matrix.prop }}.txt || true
          if ! git diff --cached --quiet; then
            git commit -m "state update (${{ matrix.prop }})"
            git push
          else
            echo "no state changes"
          fi
